# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

# ê³µí†µ í—¬í¼ ë©”ì„œë“œë“¤
def setup_app_store_api_key(options)
  # App Store Connect API í‚¤ ì„¤ì •
  app_store_connect_api_key(
    key_id: options[:api_key_id],           # API Key ID (10ìë¦¬)
    issuer_id: options[:api_key_issuer_id], # Issuer ID (UUID í˜•ì‹)
    key_filepath: options[:api_key_path]    # .p8 íŒŒì¼ ê²½ë¡œ
  )
end

def extract_build_info_from_ipa(ipa_path)
  # IPA íŒŒì¼ì—ì„œ ë¹Œë“œ ì •ë³´ ì¶”ì¶œí•˜ì—¬ ë¡œê·¸ì— ì¶œë ¥
  return unless ipa_path && File.exist?(ipa_path)
  
  UI.message "ğŸ“± Extracting build information from IPA..."
  
  begin
    # unzip ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ì„œ IPAì—ì„œ Info.plist ì¶”ì¶œ
    require 'tempfile'
    require 'fileutils'
    
    Dir.mktmpdir do |temp_dir|
      # IPA ì••ì¶• í•´ì œ
      system("unzip -q '#{ipa_path}' -d '#{temp_dir}'")
      
      # Info.plist íŒŒì¼ ì°¾ê¸°
      info_plist_path = Dir.glob("#{temp_dir}/Payload/*/Info.plist").first
      
      if info_plist_path
        # plutilì„ ì‚¬ìš©í•´ì„œ Info.plistë¥¼ JSONìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì½ê¸°
        json_output = `plutil -convert json -o - '#{info_plist_path}' 2>/dev/null`
        
        if $?.success? && !json_output.empty?
          require 'json'
          info_plist = JSON.parse(json_output)
          
          version = info_plist['CFBundleShortVersionString']
          build_number = info_plist['CFBundleVersion']
          bundle_id = info_plist['CFBundleIdentifier']
          
          UI.important "ğŸ” Build Information:"
          UI.message "   ğŸ“¦ Bundle ID: #{bundle_id}"
          UI.message "   ğŸ“± App Version: #{version}"
          UI.message "   ğŸ”¢ Build Number: #{build_number}"
          UI.message "   ğŸ“ Full Version: #{version} (#{build_number})"
          
          # ë¹Œë“œ ì •ë³´ë¥¼ í•´ì‹œë¡œ ë°˜í™˜
          {
            bundle_id: bundle_id,
            version: version,
            build_number: build_number,
            full_version: "#{version} (#{build_number})"
          }
        else
          UI.message "âš ï¸  Could not parse Info.plist from IPA"
          nil
        end
      else
        UI.message "âš ï¸  Could not find Info.plist in IPA"
        nil
      end
    end
  rescue => e
    UI.message "âš ï¸  Could not extract build info from IPA: #{e.message}"
    nil
  end
end

def process_release_notes(options)
  # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì²˜ë¦¬ ë¡œì§
  # Available language codes
  # - ar-SA, ca, cs, da, de-DE, el, en-AU, en-CA, en-GB, en-US, es-ES, es-MX, fi, fr-CA, fr-FR, 
  # - he, hi, hr, hu, id, it, ja, ko, ms, nl-NL, no, pl, pt-BR, pt-PT, ro, ru, sk, sv, th, tr, 
  # - uk, vi, zh-Hans, zh-Hant
  # ë°©ë²• 1: JSON ë¬¸ìì—´ë¡œ ì „ë‹¬ (ì˜ˆ: '{"en-US":"English notes","ko":"Korean notes"}')
  # ë°©ë²• 2: ì½¤ë§ˆ êµ¬ë¶„ í˜•ì‹ (ì˜ˆ: 'en-US:English notes,ko:Korean notes')
  # ë°©ë²• 3: íŒŒì¼ ê²½ë¡œ (ì˜ˆ: 'file:./release_notes.json')
  # ë°©ë²• 4: ê¸°ë³¸ ë¬¸ìì—´
  if options[:release_notes] && options[:release_notes].start_with?('file:')
    # íŒŒì¼ì—ì„œ ì½ê¸°
    file_path = options[:release_notes].sub('file:', '')
    if File.exist?(file_path)
      file_content = File.read(file_path)
      if file_path.end_with?('.json')
        require 'json'
        JSON.parse(file_content)
      else
        file_content
      end
    else
      "Bug fixes and improvements"
    end
  elsif options[:release_notes] && options[:release_notes].start_with?('{')
    # JSON í˜•ì‹ìœ¼ë¡œ ì „ë‹¬ëœ ê²½ìš°
    require 'json'
    parsed = JSON.parse(options[:release_notes])
    # \nì„ ì‹¤ì œ ì¤„ë°”ê¿ˆìœ¼ë¡œ ë³€í™˜
    parsed.transform_values { |v| v.gsub('\\n', "\n") }
  elsif options[:release_notes] && options[:release_notes].include?(':')
    # ì½¤ë§ˆ êµ¬ë¶„ key:value í˜•ì‹ìœ¼ë¡œ ì „ë‹¬ëœ ê²½ìš°
    notes_hash = {}
    options[:release_notes].split(',').each do |pair|
      key, value = pair.split(':', 2)
      if key && value
        # \nì„ ì‹¤ì œ ì¤„ë°”ê¿ˆìœ¼ë¡œ ë³€í™˜
        notes_hash[key.strip] = value.strip.gsub('\\n', "\n")
      end
    end
    notes_hash.empty? ? "Bug fixes and improvements" : notes_hash
  else
    # ê¸°ë³¸ ë¬¸ìì—´ ë˜ëŠ” nilì¸ ê²½ìš°
    notes = options[:release_notes] || "Bug fixes and improvements"
    notes.gsub('\\n', "\n")
  end
end

platform :ios do
  desc "Description of what the lane does"
  lane :custom_lane do
    # add actions here: https://docs.fastlane.tools/actions
  end

  desc "Export IPA with provisioning"
  lane :export do |options| 
    gym(
      workspace: options[:workspace], 
      scheme: options[:scheme],
      skip_build_archive: true,
      archive_path: options[:archive_path],
      export_method: "app-store",
      output_directory: options[:output_directory],
      export_options: {
      signingStyle: "manual",
        provisioningProfiles: {
          options[:bundle_id] => options[:provisioning_profile]
        }
      }
    )
  end

  # TestFlight ë°°í¬ìš©
  desc "Deploy to TestFlight for beta testing"
  lane :beta do |options| 
    groups = if options[:groups]
             options[:groups].split(',').map(&:strip)
           else
             ["App Store Connect Users"]
           end

    upload_to_testflight(
      ipa: options[:ipa],
      api_key: setup_app_store_api_key(options),
      skip_waiting_for_build_processing: options[:skip_waiting_for_build_processing] || false,
      groups: groups,
      changelog: options[:changelog] || "Bug fixes and improvements"
    )
  end

  # App Store ë°°í¬ìš©
  desc "Deploy to App Store with specified configuration"
  lane :release do |options|
    upload_to_app_store(
      # ì—…ë¡œë“œí•  IPA íŒŒì¼ ê²½ë¡œ
      ipa: options[:ipa],
      
      # App Store Connect API í‚¤ (ìœ„ì—ì„œ ì„¤ì •í•œ ì¸ì¦ ì •ë³´)
      api_key: setup_app_store_api_key(options),
      
      # ë©”íƒ€ë°ì´í„° ì—…ë¡œë“œ ì„¤ì •
      # false: ì•± ì„¤ëª…, í‚¤ì›Œë“œ, ì¹´í…Œê³ ë¦¬ ë“± ë©”íƒ€ë°ì´í„°ë„ í•¨ê»˜ ì—…ë¡œë“œ
      # true: ë°”ì´ë„ˆë¦¬(IPA)ë§Œ ì—…ë¡œë“œ, ë©”íƒ€ë°ì´í„°ëŠ” ê±´ë„ˆë›°ê¸°
      skip_metadata: options[:skip_metadata] || false,
      
      # ìŠ¤í¬ë¦°ìƒ· ì—…ë¡œë“œ ì„¤ì •
      # false: ì•± ìŠ¤í¬ë¦°ìƒ·ë„ í•¨ê»˜ ì—…ë¡œë“œ
      # true: ìŠ¤í¬ë¦°ìƒ· ì—…ë¡œë“œ ê±´ë„ˆë›°ê¸°
      skip_screenshots: options[:skip_screenshots] || false,
      
      # ì‹¬ì‚¬ ì œì¶œ ì„¤ì •
      # false: ì—…ë¡œë“œë§Œ í•˜ê³  ìˆ˜ë™ìœ¼ë¡œ ë‚˜ì¤‘ì— ì‹¬ì‚¬ ì œì¶œ
      # true: ì—…ë¡œë“œ í›„ ìë™ìœ¼ë¡œ Apple ì‹¬ì‚¬ì— ì œì¶œ (ë˜ëŒë¦´ ìˆ˜ ì—†ìŒ!)
      submit_for_review: options[:submit_for_review] || false,
      
      # ë°”ì´ë„ˆë¦¬ ì—…ë¡œë“œ ì„¤ì •
      # false: IPA íŒŒì¼ì„ ìƒˆë¡œ ì—…ë¡œë“œ (ê¸°ë³¸ê°’)
      # true: ë°”ì´ë„ˆë¦¬ ì—…ë¡œë“œ ê±´ë„ˆë›°ê¸°, ê¸°ì¡´ ì—…ë¡œë“œëœ ë¹Œë“œ ì‚¬ìš© (TestFlightâ†’App Store ìŠ¹ê²© ì‹œ ì‚¬ìš©)
      skip_binary_upload: options[:skip_binary_upload] || false,
      
      # ìë™ ì¶œì‹œ ì„¤ì •
      # false: ì‹¬ì‚¬ ìŠ¹ì¸ í›„ ìˆ˜ë™ìœ¼ë¡œ ì¶œì‹œ (ë§ˆì¼€íŒ… íƒ€ì´ë° ì¡°ì ˆ ê°€ëŠ¥)
      # true: ì‹¬ì‚¬ ìŠ¹ì¸ ì¦‰ì‹œ ìë™ìœ¼ë¡œ App Storeì— ì¶œì‹œ
      automatic_release: options[:automatic_release] || false,

      # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ (What's New / ë³€ê²½ì‚¬í•­) ì²˜ë¦¬
      release_notes: process_release_notes(options),
      
      # ì¸ì•± êµ¬ë§¤ ì‚¬ì „ ê²€ì‚¬ ì„¤ì •
      # false: ì¸ì•± êµ¬ë§¤ ê´€ë ¨ ì‚¬ì „ ê²€ì‚¬ ìƒëµ (ì¼ë°˜ì )
      # true: ì¸ì•± êµ¬ë§¤ ë©”íƒ€ë°ì´í„°ë„ ì‚¬ì „ ê²€ì‚¬ í¬í•¨
      precheck_include_in_app_purchases: options[:precheck_include_in_app_purchases] || false,
      
      # ì‹¬ì‚¬ ì œì¶œ ì‹œ ì¶”ê°€ ì •ë³´
      submission_information: {
        # IDFA (ê´‘ê³  ì‹ë³„ì) ì‚¬ìš© ì—¬ë¶€
        # false: ì•±ì´ IDFAë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŒì„ Appleì— ì•Œë¦¼
        # true: ì•±ì´ IDFAë¥¼ ì‚¬ìš©í•¨ì„ Appleì— ì•Œë¦¼ (ì¶”ê°€ ì‹¬ì‚¬ í•„ìš”)
        add_id_info_uses_idfa: options[:add_id_info_uses_idfa] || false
      }
    )
  end

  # ê°œë°œìš© ë¹ ë¥¸ ì—…ë¡œë“œ
  desc "Quick upload for development"
  lane :dev_release do |options|
    # IPA íŒŒì¼ì—ì„œ ë¹Œë“œ ì •ë³´ ì¶”ì¶œí•˜ì—¬ ë¡œê·¸ì— ì¶œë ¥
    build_info = extract_build_info_from_ipa(options[:ipa])

    upload_to_app_store(
      ipa: options[:ipa],
      api_key: setup_app_store_api_key(options),
      skip_metadata: true,
      skip_screenshots: true,
      submit_for_review: false,
      skip_binary_upload: options[:skip_binary_upload] || false,
      automatic_release: false,
      release_notes: process_release_notes(options),
      precheck_include_in_app_purchases: false,
      submission_information: {
        add_id_info_uses_idfa: false
      }
    )
  end

  # ì™„ì „ ìë™ ë°°í¬
  desc "Fully automated release with review submission"
  lane :auto_release do |options|
    # IPA íŒŒì¼ì—ì„œ ë¹Œë“œ ì •ë³´ ì¶”ì¶œí•˜ì—¬ ë¡œê·¸ì— ì¶œë ¥
    build_info = extract_build_info_from_ipa(options[:ipa])
    
    upload_to_app_store(
      ipa: options[:ipa],
      api_key: setup_app_store_api_key(options),
      skip_metadata: false,
      skip_screenshots: false,
      submit_for_review: true,
      skip_binary_upload: options[:skip_binary_upload] || false,
      automatic_release: true,
      release_notes: process_release_notes(options),
      precheck_include_in_app_purchases: false,
      submission_information: {
        add_id_info_uses_idfa: false
      }
    )
  end
end